name: Deploy Production (EC2)

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  # -----------------------------
  # Build & push image (reusable)
  # -----------------------------
  build:
    uses: ./.github/workflows/_build_and_push.yml
    with:
      tag: prod-${{ github.sha }}
      latest_tag: prod-latest
    secrets: inherit

  # -----------------------------
  # Deploy to EC2
  # -----------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main

      # Lowercase owner for GHCR path
      - name: Compute lowercase owner
        id: img
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      # Prepare folders on EC2
      - name: Prepare project folders
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo mkdir -p /var/www/laravel-demo
            sudo chown -R ubuntu:ubuntu /var/www/laravel-demo
            mkdir -p /var/www/laravel-demo/docker-compose/nginx
            mkdir -p /var/www/laravel-demo/storage /var/www/laravel-demo/bootstrap/cache

      # Upload docker-compose.yml
      - name: Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "/var/www/laravel-demo/"

      # Upload docker-compose configs (nginx app.conf)
      - name: Upload docker-compose configs
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose/*"
          target: "/var/www/laravel-demo/"

      # -----------------------------
      # Remote deploy on EC2
      # -----------------------------
      - name: SSH → pull image & run containers
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            cd /var/www/laravel-demo

            echo "${{ secrets.GHCR_KEY }}" | docker login ghcr.io \
              -u "${{ github.repository_owner }}" --password-stdin

            IMAGE="ghcr.io/${{ steps.img.outputs.OWNER_LC }}/laravel-demo:prod-latest"
            echo "Deploying $IMAGE"
            docker pull "$IMAGE"

            # Ensure permissions for Laravel
            sudo chown -R 33:33 storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # Verify nginx config (app.conf)
            if [ ! -f docker-compose/nginx/app.conf ]; then
              echo "❌ app.conf not found!"
              ls -la docker-compose/nginx || true
              exit 1
            fi

            docker compose up -d --remove-orphans

            # Wait for app healthcheck
            echo "Waiting for app container to become healthy..."
            for i in {1..60}; do
              cid=$(docker compose ps -q app || true)
              status="$(docker inspect --format='{{.State.Health.Status}}' "$cid" 2>/dev/null || true)"
              if [ "$status" = "healthy" ]; then
                echo "✅ App is healthy"
                break
              fi
              if [ "$i" -eq 60 ]; then
                echo "❌ App did not become healthy"
                docker compose ps
                exit 1
              fi
              sleep 2
            done

            # Laravel optimization
            docker compose exec -T app php artisan optimize:clear
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache || true
            docker compose exec -T app php artisan view:cache

            docker image prune -f --filter "until=168h"
