name: Deploy Production (EC2)

on:
  push:
    branches: [ main ]

jobs:
  build:
    uses: ./.github/workflows/_build_and_push.yml
    with:
      tag: prod-${{ github.sha }}
      latest_tag: prod-latest
    secrets: inherit

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main   # ensure we get main branch

      - name: Compute lowercase owner
        id: img
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Prepare project folders
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo mkdir -p /var/www/alizo-service-provider
            sudo chown -R ubuntu:ubuntu /var/www/alizo-service-provider
            cd /var/www/alizo-service-provider
            mkdir -p storage bootstrap/cache docker-compose/nginx
            
      # ✅ Copy entire docker-compose directory
      - name: Upload docker-compose directory
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.production.yml"
          target: "/var/www/alizo-service-provider/"
          strip_components: 0

      # ✅ Copy entire docker-compose directory
      - name: Upload docker-compose directory
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose/*"
          target: "/var/www/alizo-service-provider/"

      # ✅ Copy public directory
      - name: Upload public directory
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "public/*"
          target: "/var/www/alizo-service-provider/"

      # ✅ Remote deploy on EC2
      - name: SSH → pull & run
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "/var/www/alizo-service-provider"

            echo "${{ secrets.GHCR_KEY }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

            IMG="ghcr.io/${{ steps.img.outputs.OWNER_LC }}/alizo-service-provider:prod-latest"
            echo "Deploying $IMG"
            docker pull "$IMG"
            docker tag "$IMG" alizo-service-provider:prod-latest

            # Fix storage permissions before starting containers
            mkdir -p storage/app storage/framework/cache storage/framework/sessions storage/framework/views storage/logs
            mkdir -p docker-compose/nginx
            chmod -R 777 storage bootstrap/cache

            # Verify nginx config exists
            if [ ! -f docker-compose/nginx/nginx.conf ]; then
              echo "ERROR: nginx.conf not found!"
              ls -la docker-compose/nginx/ || echo "nginx directory not found"
              exit 1
            fi

            # Environment files should be managed on the host (not uploaded by CI)
            # (Removed automatic renaming of .env.production to .env.)

            docker compose -f docker-compose.production.yml up -d --remove-orphans

            # Wait until app is healthy
            echo "Waiting for app container to become healthy..."
            for i in {1..60}; do
              cid=$(docker compose -f docker-compose.production.yml ps -q app || true)
              status="$(docker inspect --format='{{.State.Health.Status}}' "$cid" 2>/dev/null || true)"
              if [ "$status" = "healthy" ]; then
                echo "✅ App is healthy"
                break
              fi
              if [ "$i" -eq 60 ]; then
                echo "❌ App failed to become healthy in time"
                docker compose ps
                exit 1
              fi
              sleep 2
            done

            # Run Laravel cache + migrations
            docker compose -f docker-compose.production.yml exec -T app php artisan optimize:clear
            # docker compose -f docker-compose.production.yml exec -T app php artisan migrate --force
            docker compose -f docker-compose.production.yml exec -T app php artisan config:cache
            docker compose -f docker-compose.production.yml exec -T app php artisan route:cache || true
            docker compose -f docker-compose.production.yml exec -T app php artisan view:cache

            docker image prune -f --filter "until=168h"
